# ドキュメントリビジョン管理機能 実装計画

このドキュメントは、学習コンテンツのリビジョン管理機能の実装タスクとマイルストーンを管理します。チェックボックスにより進捗状況を記録し、各ステップでの課題やメモも残します。

## 前提条件

- [x] 技術スタック確認（S3/MinIO環境が利用可能か）
- [x] 権限・アクセス設定確認
- [x] 開発環境のセットアップ

## マイルストーン1: データベース設計と実装

### 1-1. DBスキーマ作成

- [x] `documents`テーブル作成
- [x] `document_revisions`テーブル作成
- [x] `node_document_links`テーブル作成
- [x] マイグレーションファイル作成
- [x] マイグレーションテスト実行

**メモ欄**:
```
- 実装日: 2025-04-30
- マイグレーションファイル: 002_add_document_revision_tables.py
- ローカル環境でのみ動作確認済み
- 既存のroadmap_nodesテーブルとの外部キー関連付けを実装
```

### 1-2. SQLAlchemyモデル作成

- [x] `Document`モデルクラス定義
- [x] `DocumentRevision`モデルクラス定義
- [x] `NodeDocumentLink`モデルクラス定義
- [x] リレーションシップ設定
- [x] バリデーションルール実装

**メモ欄**:
```
- 実装日: 2025-04-30
- モデルファイル: backend/src/db/models/document.py
- RoadmapNodeモデルにdocument_linksリレーションシップを追加
- モデルの__init__.pyファイルを更新して新しいモデルをエクスポート
```

### 1-3. シードデータ作成

- [x] テスト用ドキュメントデータ作成
- [x] テスト用リビジョンデータ作成
- [x] テスト用ノードリンクデータ作成
- [x] シードスクリプト実装
- [x] シードデータ投入テスト

**メモ欄**:
```
- 実装日: 2025-04-30
- シードファイル: backend/src/db/seeders/document_seed.py
- ローカル環境でのファイル保存機能を実装（storage/documentsディレクトリ）
- .gitignoreにstorageディレクトリを追加し、開発環境の生成ファイルを管理対象外に
- 一部ノードハンドルがサンプルデータと一致しないため警告あり（本番環境では調整要）
```

## マイルストーン2: ストレージ連携実装

### 2-1. S3/MinIO連携モジュール

- [ ] ストレージ接続設定実装
- [ ] 環境変数・設定ファイル更新
- [ ] オブジェクトアップロード機能実装
- [ ] オブジェクト取得機能実装
- [ ] オブジェクト一覧取得機能実装
- [ ] エラーハンドリング実装

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 2-2. コンテンツJSON構造定義

- [x] JSONスキーマ定義
- [x] Pydanticモデル作成
- [x] JSONバリデーション実装
- [x] シリアライズ/デシリアライズ処理実装
- [ ] テストケース作成

**メモ欄**:
```
- 実装日: 2025-05-01
- DB用スキーマ: backend/src/db/schemas/document.py
- API用スキーマ: backend/src/api/v1/schemas/document.py
- セクション構造を持つ階層型JSONスキーマを定義
- データベースモデルとAPIレスポンス用に異なるPydanticモデルを作成
```

### 2-3. バージョン管理ロジック

- [x] セマンティックバージョン処理ユーティリティ作成
- [x] バージョン差分計算ロジック実装
- [x] バージョン生成戦略実装（major/minor/patch）
- [ ] 関連テスト実装

**メモ欄**:
```
- 実装日: 2025-05-01
- VersionUtility: セマンティックバージョニング処理
- DocumentDiffUtility: バージョン間の差分計算
- DocumentStorageService: ファイル保存・読み込み機能
- major/minor/patchの自動判定ロジックを実装
```

## マイルストーン3: バックエンドAPI実装

### 3-1. FastAPI エンドポイント実装

- [ ] ドキュメント情報取得API実装（`GET /api/v1/documents/{document_id}`）
- [ ] 最新コンテンツ取得API実装（`GET /api/v1/documents/{document_id}/content`）
- [ ] 特定バージョン取得API実装（`GET /api/v1/documents/{document_id}/content/version/{version}`）
- [ ] バージョン履歴取得API実装（`GET /api/v1/documents/{document_id}/revisions`）
- [ ] ノード関連ドキュメントAPI実装（`GET /api/v1/nodes/{node_id}/documents`）
- [ ] ドキュメント新規作成API実装（`POST /api/v1/documents`）
- [ ] ドキュメント更新API実装（`PUT /api/v1/documents/{document_id}`）
- [ ] ノードとドキュメントの関連付けAPI実装（`POST /api/v1/nodes/{node_id}/documents`）

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 3-2. サービスレイヤー実装

- [ ] ドキュメントサービスクラス作成
- [ ] リビジョン管理サービスクラス作成
- [ ] コンテンツ保存・取得サービス実装
- [ ] ノード・ドキュメント関連付けサービス実装
- [ ] バージョン差分機能実装

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 3-3. APIテスト

- [ ] ユニットテスト実装
- [ ] 統合テスト実装
- [ ] パフォーマンステスト
- [ ] エラーケーステスト
- [ ] APIドキュメント生成

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

## マイルストーン4: フロントエンド実装

### 4-1. API連携層

- [ ] APIクライアント生成（orval）
- [ ] API呼び出し用カスタムフック作成
- [ ] 型定義更新
- [ ] エラーハンドリング実装
- [ ] ユーザーストアとの連携

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 4-2. コンポーネント実装

- [ ] ドキュメントビューアーコンポーネント作成
- [ ] バージョン選択UIコンポーネント作成
- [ ] バージョン履歴タイムラインコンポーネント作成
- [ ] 差分表示コンポーネント作成
- [ ] ノードからのドキュメントリンク表示コンポーネント作成

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 4-3. ページ・ルーティング実装

- [ ] ドキュメント詳細ページ作成
- [ ] バージョン履歴ページ作成
- [ ] バージョン差分表示ページ作成
- [ ] ノードページのドキュメントリンク部分実装
- [ ] ルーティング設定更新

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 4-4. フロントエンドテスト

- [ ] コンポーネントユニットテスト
- [ ] 統合テスト
- [ ] UIテスト
- [ ] アクセシビリティテスト
- [ ] パフォーマンス最適化

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

## マイルストーン5: デプロイと検証

### 5-1. 環境設定

- [ ] 開発環境デプロイ
- [ ] ステージング環境設定
- [ ] ストレージ環境設定
- [ ] 環境変数設定

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 5-2. 機能検証

- [ ] 基本機能E2Eテスト
- [ ] エッジケーステスト
- [ ] パフォーマンステスト
- [ ] セキュリティレビュー

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 5-3. ドキュメント・マニュアル作成

- [ ] 機能概要ドキュメント
- [ ] API利用ガイド
- [ ] 管理者マニュアル
- [ ] 開発者ガイド

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

## マイルストーン6: 本番リリース

### 6-1. リリース準備

- [ ] 本番環境設定
- [ ] バックアップ設定
- [ ] モニタリング設定
- [ ] ロールバック計画

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 6-2. リリース実行

- [ ] ステージドリリース計画
- [ ] リリース実行
- [ ] モニタリング実施
- [ ] 初期データ移行

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 6-3. リリース後対応

- [ ] パフォーマンスモニタリング
- [ ] ユーザーフィードバック収集
- [ ] 初期バグ修正
- [ ] 改善提案収集

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

## 進捗状況サマリー

| マイルストーン | 開始日 | 完了予定日 | 実際の完了日 | 進捗率 | ステータス |
|--------------|-------|-----------|------------|-------|----------|
| 1. データベース設計と実装 | 2025-04-30 | 2025-05-05 | 2025-04-30 | 100% | 完了 |
| 2. ストレージ連携実装 | 2025-05-01 | 2025-05-10 | | 60% | 進行中 |
| 3. バックエンドAPI実装 | | | | 0% | 未着手 |
| 4. フロントエンド実装 | | | | 0% | 未着手 |
| 5. デプロイと検証 | | | | 0% | 未着手 |
| 6. 本番リリース | | | | 0% | 未着手 |

## リスク・課題管理

| ID | リスク/課題 | 重要度 | 対応策 | ステータス | 担当者 |
|----|------------|-------|--------|-----------|--------|
| R1 | S3が不要な初期実装でのファイル保存方法 | 中 | ローカルファイルシステムに保存する仕組みを実装 | 対応済 | - |
| R2 | | | | | |

## 議事録・コミュニケーション履歴

### 2025-04-30 実装開始

参加者:
- 開発チーム

実施内容:
- ブランチ`feature/document-revision-local`作成
- データベースモデル作成と関連付け
- マイグレーションファイル作成と適用
- シードデータスクリプト実装

決定事項:
- 初期段階ではS3ではなくローカルファイル保存で実装
- ストレージディレクトリはGit管理対象外とする

次回アクション:
- コンテンツJSON構造の定義
- Pydanticモデルの実装

### 2025-05-01 JSON構造定義とバージョン管理実装

参加者:
- 開発チーム

実施内容:
- JSONスキーマ構造の定義
- DB用とAPI用の両方のPydanticモデルを実装
- バージョン管理ユーティリティクラスの実装
- ドキュメント差分計算ロジックの実装
- ローカルストレージサービスの実装

決定事項:
- APIレスポンス用とDB保存用で異なるスキーマ構造を採用
- セマンティックバージョニングによるバージョン管理を実装

次回アクション:
- FastAPIエンドポイントの実装
- サービスレイヤーの実装
