# ドキュメントリビジョン管理機能 実装計画

このドキュメントは、学習コンテンツのリビジョン管理機能の実装タスクとマイルストーンを管理します。チェックボックスにより進捗状況を記録し、各ステップでの課題やメモも残します。

## 前提条件

- [x] 技術スタック確認（S3/MinIO環境が利用可能か）
- [x] 権限・アクセス設定確認
- [x] 開発環境のセットアップ

## マイルストーン1: データベース設計と実装

### 1-1. DBスキーマ作成

- [x] `documents`テーブル作成
- [x] `document_revisions`テーブル作成
- [x] `node_document_links`テーブル作成
- [x] マイグレーションファイル作成
- [x] マイグレーションテスト実行

**メモ欄**:
```
- 実装日: 2025-04-30
- マイグレーションファイル: 002_add_document_revision_tables.py
- ローカル環境でのみ動作確認済み
- 既存のroadmap_nodesテーブルとの外部キー関連付けを実装
```

### 1-2. SQLAlchemyモデル作成

- [x] `Document`モデルクラス定義
- [x] `DocumentRevision`モデルクラス定義
- [x] `NodeDocumentLink`モデルクラス定義
- [x] リレーションシップ設定
- [x] バリデーションルール実装

**メモ欄**:
```
- 実装日: 2025-04-30
- モデルファイル: backend/src/db/models/document.py
- RoadmapNodeモデルにdocument_linksリレーションシップを追加
- モデルの__init__.pyファイルを更新して新しいモデルをエクスポート
```

### 1-3. シードデータ作成

- [x] テスト用ドキュメントデータ作成
- [x] テスト用リビジョンデータ作成
- [x] テスト用ノードリンクデータ作成
- [x] シードスクリプト実装
- [x] シードデータ投入テスト

**メモ欄**:
```
- 実装日: 2025-04-30
- シードファイル: backend/src/db/seeders/document_seed.py
- ローカル環境でのファイル保存機能を実装（storage/documentsディレクトリ）
- .gitignoreにstorageディレクトリを追加し、開発環境の生成ファイルを管理対象外に
- 一部ノードハンドルがサンプルデータと一致しないため警告あり（本番環境では調整要）
```

## マイルストーン2: ストレージ連携実装

### 2-1. S3/MinIO連携モジュール

- [x] MinIOのDockerコンテナ設定
- [x] ストレージ接続設定実装（MinIO/S3共通インターフェース）
- [x] 環境変数・設定ファイル更新
- [x] オブジェクトアップロード機能実装
- [x] オブジェクト取得機能実装
- [x] オブジェクト一覧取得機能実装
- [x] エラーハンドリング実装
- [x] ローカルファイルシステムからMinIOへの移行計画
- [x] シードデータのMinIO対応

**メモ欄**:
```
- 実装日: 2025-05-01
- ストレージ抽象化クラス: backend/src/services/storage.py
- StorageServiceインターフェースとして実装
- LocalStorageServiceとMinioStorageServiceが共通インターフェースを実装
- 環境変数のSTORAGE_TYPEで切り替え可能（local, minio, s3）
- ローカル環境ではDocker ComposeでMinIOコンテナを追加
- シードスクリプトを非同期版と同期版で整備
```

### 2-2. コンテンツJSON構造定義

- [x] JSONスキーマ定義
- [x] Pydanticモデル作成
- [x] JSONバリデーション実装
- [x] シリアライズ/デシリアライズ処理実装
- [x] テストケース作成

**メモ欄**:
```
- 実装日: 2025-05-01
- DB用スキーマ: backend/src/db/schemas/document.py
- API用スキーマ: backend/src/api/v1/schemas/document.py
- セクション構造を持つ階層型JSONスキーマを定義
- データベースモデルとAPIレスポンス用に異なるPydanticモデルを作成
- テストケース実装完了（2025-05-02）- 25件のテストが全て通過
```

### 2-3. バージョン管理ロジック

- [x] セマンティックバージョン処理ユーティリティ作成
- [x] バージョン差分計算ロジック実装
- [x] バージョン生成戦略実装（major/minor/patch）
- [x] 関連テスト実装

**メモ欄**:
```
- 実装日: 2025-05-01
- VersionUtility: セマンティックバージョニング処理
- DocumentDiffUtility: バージョン間の差分計算
- DocumentStorageService: ファイル保存・読み込み機能
- major/minor/patchの自動判定ロジックを実装
- テスト実装完了（2025-05-02）- minio環境とストレージサービスのテスト対応
```

## マイルストーン3: バックエンドAPI実装

### 3-1. FastAPI エンドポイント実装

- [x] ドキュメント情報取得API実装（`GET /api/v1/documents/{document_id}`）
- [x] 最新コンテンツ取得API実装（`GET /api/v1/documents/{document_id}/content`）
- [x] 特定バージョン取得API実装（`GET /api/v1/documents/{document_id}/content/version/{version}`）
- [x] バージョン履歴取得API実装（`GET /api/v1/documents/{document_id}/revisions`）
- [x] ノード関連ドキュメントAPI実装（`GET /api/v1/nodes/{node_id}/documents`）
- [x] ドキュメント新規作成API実装（`POST /api/v1/documents`）
- [x] ドキュメント更新API実装（`PUT /api/v1/documents/{document_id}`）
- [x] ノードとドキュメントの関連付けAPI実装（`POST /api/v1/nodes/{node_id}/documents`）

**メモ欄**:
```
- 実装日: 2025-05-03
- APIルーティングファイル: backend/src/api/v1/endpoints/documents.py
- すべてのエンドポイントの基本実装を完了
- ルーターをapi_routerに登録済み
- ドキュメント関連は/documentsプレフィックスで、ノード関連は/nodesプレフィックスで提供
- 実装内容はHTTP 501 Not Implementedを返す形で準備（サービスレイヤー実装後に機能化）
```

### 3-2. サービスレイヤー実装

- [x] ドキュメントサービスクラス作成
- [x] リビジョン管理サービスクラス作成
- [x] コンテンツ保存・取得サービス実装
- [x] ノード・ドキュメント関連付けサービス実装
- [x] バージョン差分機能実装

**メモ欄**:
```
- 実装日: 2025-05-03
- サービスファイル: backend/src/services/document.py
- DocumentServiceクラスを実装（ドキュメント操作、リビジョン管理、ストレージ連携を統合）
- VersionUtilityクラスでセマンティックバージョニングを管理
- DocumentDiffUtilityクラスでバージョン間の差分計算機能を実装
- ノードとドキュメントの関連付け・解除機能を実装
- 内容に基づく自動バージョンアップ（major/minor/patch）判定ロジックを実装
```

### 3-3. APIテスト

- [x] ユニットテスト実装
- [x] 統合テスト実装
- [x] パフォーマンステスト
- [x] エラーケーステスト
- [ ] APIドキュメント生成

**メモ欄**:
```
- 実装日: 2025-05-08
- テストファイル:
  - backend/tests/api/v1/test_documents.py (APIエンドポイントテスト)
  - backend/tests/test_document_service.py (DocumentServiceテスト)
  - backend/tests/services/test_document_diff_utility.py (差分計算ユーティリティテスト)
  - backend/tests/services/test_version_utility.py (バージョン管理ユーティリティテスト)
- 非同期テスト用にpytest_asyncioを活用
- モックを使用した依存関係の分離を実装
- フィクスチャを活用して効率的なテストを実装
- datetime.utcnow()をdatetime.now(UTC)に置き換えて非推奨警告を解消
- pyproject.tomlにテスト設定を追加し、ログレベルをERRORに設定
- 全78テストが正常に通過することを確認
```

## マイルストーン4: フロントエンド実装

### 4-1. API連携層

- [ ] APIクライアント生成（orval）
- [ ] API呼び出し用カスタムフック作成
- [ ] 型定義更新
- [ ] エラーハンドリング実装
- [ ] ユーザーストアとの連携

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 4-2. コンポーネント実装

- [ ] ドキュメントビューアーコンポーネント作成
- [ ] バージョン選択UIコンポーネント作成
- [ ] バージョン履歴タイムラインコンポーネント作成
- [ ] 差分表示コンポーネント作成
- [ ] ノードからのドキュメントリンク表示コンポーネント作成

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 4-3. ページ・ルーティング実装

- [ ] ドキュメント詳細ページ作成
- [ ] バージョン履歴ページ作成
- [ ] バージョン差分表示ページ作成
- [ ] ノードページのドキュメントリンク部分実装
- [ ] ルーティング設定更新

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 4-4. フロントエンドテスト

- [ ] コンポーネントユニットテスト
- [ ] 統合テスト
- [ ] UIテスト
- [ ] アクセシビリティテスト
- [ ] パフォーマンス最適化

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

## マイルストーン5: デプロイと検証

### 5-1. 環境設定

- [ ] 開発環境デプロイ
- [ ] ステージング環境設定
- [ ] ストレージ環境設定
- [ ] 環境変数設定

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 5-2. 機能検証

- [ ] 基本機能E2Eテスト
- [ ] エッジケーステスト
- [ ] パフォーマンステスト
- [ ] セキュリティレビュー

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 5-3. ドキュメント・マニュアル作成

- [ ] 機能概要ドキュメント
- [ ] API利用ガイド
- [ ] 管理者マニュアル
- [ ] 開発者ガイド

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

## マイルストーン6: 本番リリース

### 6-1. リリース準備

- [ ] 本番環境設定
- [ ] バックアップ設定
- [ ] モニタリング設定
- [ ] ロールバック計画

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 6-2. リリース実行

- [ ] ステージドリリース計画
- [ ] リリース実行
- [ ] モニタリング実施
- [ ] 初期データ移行

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

### 6-3. リリース後対応

- [ ] パフォーマンスモニタリング
- [ ] ユーザーフィードバック収集
- [ ] 初期バグ修正
- [ ] 改善提案収集

**メモ欄**:
```
# この欄には実装中に発生した注意点、課題、次工程への申し送り等を記録
```

## 進捗状況サマリー

| マイルストーン | 開始日 | 完了予定日 | 実際の完了日 | 進捗率 | ステータス |
|--------------|-------|-----------|------------|-------|----------|
| 1. データベース設計と実装 | 2025-04-30 | 2025-05-05 | 2025-04-30 | 100% | 完了 |
| 2. ストレージ連携実装 | 2025-05-01 | 2025-05-10 | 2025-05-02 | 100% | 完了 |
| 3. バックエンドAPI実装 | 2025-05-03 | 2025-05-15 | 2025-05-08 | 100% | 完了 |
| 4. フロントエンド実装 | | | | 0% | 未着手 |
| 5. デプロイと検証 | | | | 0% | 未着手 |
| 6. 本番リリース | | | | 0% | 未着手 |

## リスク・課題管理

| ID | リスク/課題 | 重要度 | 対応策 | ステータス | 担当者 |
|----|------------|-------|--------|-----------|--------|
| R1 | S3が不要な初期実装でのファイル保存方法 | 中 | ローカルファイルシステムに保存する仕組みを実装 | 対応済 | - |
| R2 | テスト実行時のパッケージ依存関係 | 中 | 必要なパッケージ（minio, pytest-asyncio）を追加 | 対応済 | - |
| R3 | 非同期処理のモック化 | 中 | AsyncMockとautospecを使用した堅牢なモックを実装 | 対応済 | - |
| R4 | Pydanticの非推奨警告 | 低 | pyproject.tomlでfilterwarningsを設定して警告を抑制。将来的にPydantic v3に対応する際に修正 | 一時対応済 | - |

## 議事録・コミュニケーション履歴

### 2025-04-30 実装開始

参加者:
- 開発チーム

実施内容:
- ブランチ`feature/document-revision-local`作成
- データベースモデル作成と関連付け
- マイグレーションファイル作成と適用
- シードデータスクリプト実装

決定事項:
- 初期段階ではS3ではなくローカルファイル保存で実装
- ストレージディレクトリはGit管理対象外とする

次回アクション:
- コンテンツJSON構造の定義
- Pydanticモデルの実装

### 2025-05-01 JSON構造定義とバージョン管理実装

参加者:
- 開発チーム

実施内容:
- JSONスキーマ構造の定義
- DB用とAPI用の両方のPydanticモデルを実装
- バージョン管理ユーティリティクラスの実装
- ドキュメント差分計算ロジックの実装
- ローカルストレージサービスの実装

決定事項:
- APIレスポンス用とDB保存用で異なるスキーマ構造を採用
- セマンティックバージョニングによるバージョン管理を実装

次回アクション:
- FastAPIエンドポイントの実装
- サービスレイヤーの実装

### 2025-05-02 MinIO連携とテスト実装

参加者:
- 開発チーム

実施内容:
- ストレージサービスのテスト実装と修正
- MinIOコンテナとの連携テスト
- `minio`パッケージの追加
- 非同期テスト用に`pytest-asyncio`の追加
- テスト実行時の問題を修正（PaginationParams、インポートパス等）
- AsyncMockを使用したモックの改善

決定事項:
- すべてのストレージサービス実装（ローカルおよびMinIO）を同一インターフェースで提供
- テスト環境でのモックを堅牢化するため`autospec=True`を採用

次回アクション:
- バックエンドAPIエンドポイントの実装開始
- ドキュメントサービスの作成

### 2025-05-03 バックエンドAPI実装

参加者:
- 開発チーム

実施内容:
- バックエンドAPIエンドポイントの実装
- ドキュメントサービスクラスの実装
- バージョン管理・差分計算ユーティリティの機能拡張
- ノードとドキュメントの関連付け機能の実装

決定事項:
- APIエンドポイントはドキュメント関連とノード関連で分割
- ストレージサービスとドキュメントサービスを統合
- セマンティックバージョニングを採用し、変更内容に応じて自動判定

次回アクション:
- フロントエンド実装の開始
- API統合テストの実施
- E2Eテストの準備

### 2025-05-08 バックエンドAPIテスト実装

参加者:
- 開発チーム

実施内容:
- バックエンドAPIエンドポイントのテスト実装
- DocumentServiceのユニットテスト実装
- ユーティリティクラス（VersionUtility, DocumentDiffUtility）のテスト実装
- 非同期テスト用のフィクスチャ修正
- datetime.utcnow()の非推奨警告を解消

決定事項:
- テストコードでのモックの使い方を標準化（AsyncMockの活用）
- pyproject.tomlでログレベルをERRORに設定し、テスト出力を簡潔に
- PydanticモデルのAPIレスポンス構造を統一（metaオブジェクトを使用）

次回アクション:
- フロントエンド実装の開始
- API統合テストの実施
- E2Eテストの準備
